syntax = "proto3";
package io.axoniq.axonserver.grpc.event.dcb;
option java_multiple_files = true;

service DcbEventStore {

  rpc Append (stream AppendRequest) returns (AppendResponse);

  // finite
  rpc Source (SourceRequest) returns (stream SourceResponse);

  // infinite
  rpc Stream (StreamRequest) returns (stream StreamResponse);
}

// Shared
// PlainEvent, Raw, NakedEvent, IdentifiableEventPayload

// Event storage engine
message IdentifiableEventPayload {
  /* The unique identifier of this event */
  string identifier = 1;

  reserved 2, 3, 4, 5, 6, 7, 8;
  /* The Payload of the Event */
  bytes payload = 9;
}

message Tag {
  bytes key = 1;
  bytes value = 2;
}

message TypedEventPayload {
  IdentifiableEventPayload event = 1;
  string type = 2;
}

message TaggedEventPayload {
  TypedEventPayload typed_event = 1;
  repeated Tag tag = 2;
}

// Appending
message AppendRequest {
  ConsistencyCondition condition = 1;
  Event event = 2;

  message Event {
    TaggedEventPayload event = 1;
  }
}

message AppendResponse {
  Position last_position = 1;
}

// Sourcing
message SourceRequest {
  int64 from_sequence = 1;
  int64 to_sequence = 2;
  repeated Criterion criterion = 3;
}

message SourceResponse {
  oneof result {
    // ServetSentEvent, DomainEvent, SourcedEvent, TypedEvent, Item
    Event event = 1; // plain event, tags, type, timestamp, filterkey
    Position consistency_marker = 2;
  }

  message Event {
    repeated string filter_key = 1;
    int64 timestamp = 2;
    TaggedEventPayload tagged_event = 3;
  }
}

message ConsistencyCondition {
  /**
- The Position to start checking for the consistency of an append
- Examples
  - When Consistency marker is n (where n > 0), event with Global Sequence Number n will be checked
  - When Consistency marker is 0, the first event in the event store (Global Sequence Number = 0) will be checked
  - When Consistency marker is the `Seed`, the check starts with the very first event (if any) in the event store
  - When creating a new command model, `Seed` can be used to verify the
    command model has never been used before.
    Subsequent appends for this command model **must** use ConsistencyMarker of at least the
    Global Sequence Number of the latest event in the command model
   */
  Position consistency_marker = 1;
  repeated Criterion criterion = 2;
}

/**
Marks the position in or before the event stream
- Either
  - The `Head`
  - Global Sequence Number of an event
May contain shard or tier information as well.
 */
message Position {
  oneof raw {
    int64 sequence = 1;
    Head head = 2;
  }
}

/**
  Denotes the position of the _head_ of the event stream
 */
message Head {

}

message Criterion {
  string filter_key = 1;
  oneof criterion {
    TagsAndTypesCriterion tags_and_types = 2;
  }
}

message TagsAndTypesCriterion {
  repeated string type = 1;
  repeated Tag tag = 2;
}

// criteria(criterion(type(StudentSubscribed), type(StudentUnsubscribed), studentId(1), course(1)))

// Streaming

message StreamRequest {
  /* The token to start streaming from */
  int64 from_sequence = 1;
}

message StreamResponse {
  int64 tracking_token = 1;
  Event event = 2;

  message Event {
    TypedEventPayload typed_event = 1;
  }
}
